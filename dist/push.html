<!DOCTYPE html>
<html>
    <head>
        <title>Il Fatto Quotidiano Progressive WebApp</title>
        <meta charset="utf-8">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#de0000">
        <link rel="manifest" href="/manifest.json">
        <link rel="stylesheet" href="/static/css/app.css">
        <link rel="apple-touch-icon" href="/static/img/icon.png">
        <link rel="apple-touch-startup-image" href="/static/img/splash.png">
    </head>
    <body>
        <form>
            Notification payload: <input id='notification-payload' type='text' value='Insert here a payload'></input>
            Notification delay: <input id='notification-delay' type='number' value='5'></input> seconds
            Notification Time-To-Live: <input id='notification-ttl' type='number' value='0'></input> seconds
        </form>

    <button id="doIt">Request sending a notification!</button>
    <script>
    var endpoint;
        // Register a Service Worker.
        navigator.serviceWorker.register('push-worker.js')
        .then(function(registration) {
          // Use the PushManager to get the user's subscription to the push service.
          return registration.pushManager.getSubscription()
          .then(function(subscription) {
            // If a subscription was found, return it.
            if (subscription) {
              return subscription;
            }

            // Otherwise, subscribe the user (userVisibleOnly allows to specify that we don't plan to
            // send notifications that don't have a visible effect for the user).
            return registration.pushManager.subscribe({ userVisibleOnly: true });
          });
        }).then(function(subscription) {
          endpoint = subscription.endpoint;

          // Send the subscription details to the server using the Fetch API.
          fetch('./register', {
            method: 'post',
            headers: {
              'Content-type': 'application/json'
            },
            body: JSON.stringify({
              endpoint: subscription.endpoint,
            }),
          });
        });

        document.getElementById('doIt').onclick = function() {
          var payload = document.getElementById('notification-payload').value;
          var delay = document.getElementById('notification-delay').value;
          var ttl = document.getElementById('notification-ttl').value;

          // Ask the server to send the client a notification (for testing purposes, in actual
          // applications the push notification is likely going to be generated by some event
          // in the server).
          fetch('./sendNotification', {
            method: 'post',
            headers: {
              'Content-type': 'application/json'
            },
            body: JSON.stringify({
              endpoint: endpoint,
              payload: payload,
              delay: delay,
              ttl: ttl,
            }),
          });
        };
    </script>
    </body>
</html>
